YUI.add("photostream-route",(function(e){var t=require("hermes-core/type-validator"),o=50,r=100,i="pu";function s(e){s.superclass.constructor.call(this,e)}e.Routes[this.name]=s,e.extend(s,e.FlickrRoute,{langBundles:this.details.langBundles,run:function(s){var a,n,l,u=this,d=s.params.nsid_or_path_alias,p=!!s.headers&&s.headers["user-agent"],m=s.params&&s.params.photo_id,h=m?r:25,c=this.getPageNumber(s),g={},f=[],P=this.appContext.getViewer(),w=s.geo;p&&null!==p.match(/^Twitterbot/i)?this.isTwitterbot=!0:this.isTwitterbot=!1,this.isEdit=s.params&&s.params.edit,this.isCameraroll=s.query&&void 0!==s.query.cameraroll,this.showShareOnLoad=void 0!==s.query.share,n=this.isEdit?"/photos/"+d+"/edit/":"/photos/"+d+"/";var v=s.query&&""===s.query.helloPro||!1,R=s.query&&void 0!==s.query.giftPro;return(a={page:r/h*(c-1)+1,perPage:h,withPhotoId:m}).orderBy="use_pref",a.viewAs=u.isCameraroll?"me":"use_pref",a.createCompoundID=!m,t.nsid(d)?g.id=d:g.pathAlias=d,(P.signedIn||s.probableUser)&&(f.push(this.appContext.getModel("person-preferences-models",P.signedIn?P.nsid:s.probableUser)),f.push(this.appContext.getModel("person-contacts-count-models",g))),e.Promise.all(f).catch((function(e){if(e.getModelFailure&&s.probableUser)return s.probableUser=null,[];throw e})).then((function(p){var h,f,P,x=!!p[0]&&p[0],C=0,I={};return t.nsid(d)&&x&&(i=x.getValue("photostreamViewAsPref"),f=u.buildContextSuffix(x,d),g.id=d+"-"+f),u.appContext.getModel("photostream-models",g,a).then((function(p){if(P=p.getValue("owner").getValue("nsid"),YUI.Env.isServer&&(C=Math.ceil(p.getValue("totalItems")/r),c>C&&a.page>1&&!isNaN(parseInt(s.params.page_number,10))))return e.Promise.resolve({redirect:n.replace(/page[0-9]+/,"")});if(t.nsid(d)||(x?(i=x.getValue("photostreamViewAsPref"),f=u.buildContextSuffix(x,P),g.id=P+"-"+f):g.id=P),I.withPhotoId=m,I.contextSuffix=f,I.baseURL=n,I.isHelloPro=v,I.layoutPref=x?x.getValue("photostreamViewLayoutPref"):void 0,p.getValue("owner").getValue("isPro")&&(R=!1),I.openGiftPro=R,m){if(h=p.getValue("photoPageList"),-1===(l=h.getPageOf({id:m},o))||h.getNextIncompletePage(a)===l)return a.forceAPICall=!0,t.nsid(d)?a.id=d:a.pathAlias=d,h.getPage(a).then((function(e){return c=Math.ceil(h.getPageOf({id:m},o)*o/r),l=c,u.onRouteResolved(p,c,l,I,w)}),(function(t){return e.Promise.resolve({redirect:n})}));c=Math.ceil(h.getPageOf({id:m},o)*o/r),l=c}else l=2*(c-1)+1;return u.onRouteResolved(p,c,l,I,w)}),(function(t){return t&&m?e.Promise.resolve({redirect:n}):t.timeout?u.appContext.getModel("person-models",g).then((function(t){var o=t.getValue("displayname"),r={view:"empty-page-view",title:o,params:{geo:w,isSlow:!0,viewAs:u.isCameraroll?"me":i,page:"photostream",displayName:o,nsid:t.getValue("nsid"),isCamerarollPhotostream:u.isCameraroll}};return e.Promise.resolve(r)}),(function(){return u.onRouteRejected(t,s)})):u.onRouteRejected(t,s,n)}))})).catch((function(e){return u.onRouteRejected(e,s,n)}))},buildContextSuffix:function(t,o){return e.Models["person-preferences-models"].buildContextSuffix(t,o)},onRouteResolved:function(t,s,a,n,l){var u,d=t.getValue("totalItems"),p=t.getValue("owner").getValue("displayname"),m=t.getValue("owner").getValue("nsid"),h=this.appContext.getViewer(),c=!1;if(0===parseInt(d,10))u={view:"empty-page-view",title:p,params:{geo:l,isHelloPro:n.isHelloPro,openGiftPro:n.openGiftPro,displayName:p,nsid:e.Models["photostream-models"].splitCompoundId(t.id).nsid,viewAs:this.isCameraroll?"me":i,page:"photostream",isCamerarollPhotostream:this.isCameraroll}};else{if(c=h.signedIn&&h.nsid===m,this.isEdit&&!c)return e.Promise.resolve({redirect:n.baseURL.replace(/\/edit/,"")});if(this.isEdit)return e.Promise.resolve({redirect:"/cameraroll"});u={view:"photostream-page-view",title:p,params:{geo:l,isHelloPro:n.isHelloPro,openGiftPro:n.openGiftPro,nsid:e.Models["photostream-models"].splitCompoundId(t.id).nsid,withPhotoId:n.withPhotoId,isTwitterbot:this.isTwitterbot,ownerIsPro:t.getValue("owner").getValue("isPro"),contextId:m+"-"+n.contextSuffix,pageParams:{page:a,perPage:n.withPhotoId?r:o,viewPageSize:r,nominalPage:s,idAttribute:"contextId",createCompoundID:!n.withPhotoId},baseURL:n.baseURL,contextSuffix:n.contextSuffix,isCameraroll:this.isCameraroll,showShareOnLoad:this.showShareOnLoad,canChangeLayout:c&&!!n.layoutPref,layoutPref:n.layoutPref}}}return e.Promise.resolve(u)},onRouteRejected:function(t,o,r){if(t.fatal)throw t;return 15===t.code?e.Promise.resolve({redirect:r}):5===t.code?this.displayRouteErrors(o,new e.RouteError(410,this.intlMessage({intlName:"common.404_PHOTOSTREAM_DELETED"}))):this.displayRouteErrors(o,new e.RouteError(404,this.intlMessage({intlName:"common.404_PHOTOSTREAM_NONEXISTENT"})))}}),e.mix(s.prototype,e.Localizable)}),"@VERSION@",{requires:["flickr-route","flickr-promise","photostream-models","person-preferences-models"],optionalRequires:["hermes-core"],langBundles:["common"]});